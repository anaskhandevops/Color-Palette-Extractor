<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Color Palette Extractor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Simple loading spinner */
        .loader {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #4f46e5; /* Indigo */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 0 auto; /* Center spinner */
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Style for the message box */
        #message-box {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            pointer-events: none;
        }
        #message-box.show {
            opacity: 1;
            pointer-events: auto;
        }
        #message-box.success {
            background-color: #d1fae5; /* Tailwind green-100 */
            color: #065f46; /* Tailwind green-800 */
        }
        #message-box.error {
             background-color: #fee2e2; /* Tailwind red-100 */
            color: #991b1b; /* Tailwind red-800 */
        }

        /* Style for color swatches */
        .color-swatch {
            width: 60px;
            height: 60px;
            border-radius: 8px; /* Rounded corners */
            border: 1px solid #e5e7eb; /* Light gray border */
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        /* Style for file input */
        input[type="file"] {
            cursor: pointer;
        }
        /* Style the file input button using Tailwind */
        .file-input-button {
             display: inline-block;
             padding: 0.5rem 1rem;
             cursor: pointer;
             border-radius: 0.375rem; /* rounded-md */
             background-color: #ffffff; /* bg-white */
             color: #4f46e5; /* text-indigo-600 */
             border: 1px solid #d1d5db; /* border-gray-300 */
             font-weight: 500; /* font-medium */
             transition: background-color 0.15s ease-in-out;
        }
        .file-input-button:hover {
             background-color: #f9fafb; /* hover:bg-gray-50 */
        }
        /* Hide the default file input visually but keep it accessible */
        #imageInput {
            width: 0.1px;
            height: 0.1px;
            opacity: 0;
            overflow: hidden;
            position: absolute;
            z-index: -1;
        }

    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="bg-white p-6 sm:p-8 rounded-lg shadow-lg w-full max-w-2xl">

        <h1 class="text-xl sm:text-2xl font-semibold text-center text-gray-700 mb-6">
            Extract Dominant Colors from an Image
        </h1>

        <div class="mb-4 text-center">
             <label for="imageInput" class="file-input-button">
                 Choose Image File
             </label>
             <input type="file" id="imageInput" accept="image/*" class="mt-2">
             <p id="fileName" class="text-sm text-gray-500 mt-2">No file chosen</p>
             <img id="imagePreview" src="#" alt="Image Preview" class="mt-4 max-w-xs mx-auto rounded hidden"/>
        </div>

        <button id="extractBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-4 rounded-md flex items-center justify-center space-x-2 transition duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50" disabled>
            <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9.53 16.122a3 3 0 00-5.78 1.128 2.25 2.25 0 01-2.4 2.245 4.5 4.5 0 008.4-2.245c0-.399-.078-.78-.22-1.128zm0 0a15.998 15.998 0 003.388-1.62m-5.043-.025a15.994 15.994 0 011.622-3.395m3.42 3.42a15.995 15.995 0 004.764-4.648l3.876-5.814a1.151 1.151 0 00-1.597-1.597L14.146 6.32a15.996 15.996 0 00-4.649 4.763m3.42 3.42a6.776 6.776 0 00-3.42-3.42" />
            </svg>
            <span>Extract Colors</span>
        </button>

        <div id="loadingIndicator" class="mt-6 hidden">
             <div class="loader"></div>
             <p class="text-center text-gray-500 text-sm mt-2">Analyzing Image...</p>
        </div>

        <div id="paletteSection" class="mt-6 bg-gray-50 p-4 rounded-lg border border-gray-200 hidden">
             <div class="flex items-center mb-4">
                 <svg class="w-6 h-6 text-indigo-600 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                   <path stroke-linecap="round" stroke-linejoin="round" d="M4.098 19.902a3.75 3.75 0 005.304 0l6.401-6.402a3.75 3.75 0 00-.621-6.21l-2.51 2.517a.75.75 0 01-1.06 0l-2.517-2.51a3.75 3.75 0 00-6.21.622l-1.732 3.464a3.75 3.75 0 000 5.304l6.401 6.402zM10.75 8.25l2.51 2.517a.75.75 0 010 1.06l-2.517 2.51M15.75 10.75l2.51 2.517a.75.75 0 010 1.06l-2.517 2.51" />
                </svg>
                <h2 class="text-lg font-semibold text-gray-800">Dominant Colors</h2>
            </div>
            <div id="paletteDisplay" class="flex flex-wrap gap-4 justify-center">
                </div>
        </div>

        <canvas id="imageCanvas" class="hidden"></canvas>

        <div id="message-box"></div>

    </div>

    <script>
        // Get references to the DOM elements
        const imageInput = document.getElementById('imageInput');
        const fileNameDisplay = document.getElementById('fileName');
        const imagePreview = document.getElementById('imagePreview');
        const extractBtn = document.getElementById('extractBtn');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const paletteSection = document.getElementById('paletteSection');
        const paletteDisplay = document.getElementById('paletteDisplay');
        const canvas = document.getElementById('imageCanvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true }); // Important for performance
        const messageBox = document.getElementById('message-box');

        let messageTimeout; // To manage the message box timeout
        let selectedFile = null; // Store the selected file

        // Function to show messages
        function showMessage(text, type = 'success') {
            if (messageTimeout) clearTimeout(messageTimeout);
            messageBox.textContent = text;
            messageBox.className = `show ${type}`;
            messageTimeout = setTimeout(() => {
                messageBox.className = messageBox.className.replace('show', '');
                messageTimeout = null;
            }, 3000);
        }

        // Function to convert RGB to Hex
        function rgbToHex(r, g, b) {
             // Ensure values are within the valid range 0-255
            r = Math.max(0, Math.min(255, r));
            g = Math.max(0, Math.min(255, g));
            b = Math.max(0, Math.min(255, b));
            // Convert to hex
            return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1).toUpperCase();
        }

        // Event listener for file input change
        imageInput.addEventListener('change', (event) => {
            selectedFile = event.target.files[0];
            if (selectedFile) {
                if (!selectedFile.type.startsWith('image/')) {
                    showMessage('Please select an image file.', 'error');
                    imageInput.value = '';
                    fileNameDisplay.textContent = 'No file chosen';
                    imagePreview.classList.add('hidden');
                    extractBtn.disabled = true;
                    selectedFile = null;
                    return;
                }

                fileNameDisplay.textContent = selectedFile.name;
                extractBtn.disabled = false;

                const reader = new FileReader();
                reader.onload = function(e) {
                    imagePreview.src = e.target.result;
                    imagePreview.classList.remove('hidden');
                }
                reader.readAsDataURL(selectedFile);
                paletteSection.classList.add('hidden');

            } else {
                fileNameDisplay.textContent = 'No file chosen';
                imagePreview.classList.add('hidden');
                extractBtn.disabled = true;
                selectedFile = null;
            }
        });

        // Event listener for the Extract Colors button
        extractBtn.addEventListener('click', () => {
            if (!selectedFile) {
                showMessage('Please select an image file first.', 'error');
                return;
            }

            loadingIndicator.classList.remove('hidden');
            paletteSection.classList.add('hidden');
            extractBtn.disabled = true;

            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    // --- Image Processing Starts ---
                    try {
                        // Resize canvas for processing
                        const maxDim = 150; // Reduced dimension for faster processing
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > maxDim) {
                                height *= maxDim / width;
                                width = maxDim;
                            }
                        } else {
                            if (height > maxDim) {
                                width *= maxDim / height;
                                height = maxDim;
                            }
                        }
                        canvas.width = Math.round(width);
                        canvas.height = Math.round(height);

                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        const data = imageData.data;

                        // --- Enhanced: Color Quantization using Binning ---
                        const colorBins = {};
                        // Adjust binSize: smaller value = more bins/detail, larger = fewer bins/more grouping
                        const binSize = 32; // Group colors into bins of size 32x32x32 in RGB space
                        const step = 1; // Sample every pixel on the smaller canvas

                        for (let i = 0; i < data.length; i += 4 * step) {
                            const r = data[i];
                            const g = data[i + 1];
                            const b = data[i + 2];
                            const a = data[i + 3];

                            if (a < 128) continue; // Skip transparent pixels

                            // Calculate the bin key by reducing color precision
                            const binR = Math.floor(r / binSize);
                            const binG = Math.floor(g / binSize);
                            const binB = Math.floor(b / binSize);
                            const binKey = `${binR},${binG},${binB}`;

                            // Initialize bin if it doesn't exist
                            if (!colorBins[binKey]) {
                                colorBins[binKey] = { count: 0, sumR: 0, sumG: 0, sumB: 0 };
                            }

                            // Add pixel color to the bin's sum and increment count
                            colorBins[binKey].count += 1;
                            colorBins[binKey].sumR += r;
                            colorBins[binKey].sumG += g;
                            colorBins[binKey].sumB += b;
                        }

                        // Convert bins object to an array and sort by count
                        const sortedBins = Object.values(colorBins).sort((a, b) => b.count - a.count);

                        // Get top N colors (calculate average color for each top bin)
                        const numColors = 8; // Number of colors to extract
                        const topColors = sortedBins.slice(0, numColors).map(bin => {
                            const avgR = Math.round(bin.sumR / bin.count);
                            const avgG = Math.round(bin.sumG / bin.count);
                            const avgB = Math.round(bin.sumB / bin.count);
                            return {
                                r: avgR,
                                g: avgG,
                                b: avgB,
                                hex: rgbToHex(avgR, avgG, avgB)
                            };
                        });

                        // --- Display Results ---
                        paletteDisplay.innerHTML = ''; // Clear previous results
                        if (topColors.length === 0) {
                             paletteDisplay.innerHTML = '<p class="text-gray-500">Could not extract colors (maybe image is transparent?).</p>';
                        } else {
                            topColors.forEach(color => {
                                const swatchContainer = document.createElement('div');
                                swatchContainer.className = 'flex flex-col items-center';

                                const swatch = document.createElement('div');
                                swatch.className = 'color-swatch';
                                swatch.style.backgroundColor = color.hex;
                                swatch.title = `Click to copy ${color.hex}`;
                                swatch.style.cursor = 'pointer';
                                swatch.addEventListener('click', () => {
                                    navigator.clipboard.writeText(color.hex)
                                        .then(() => showMessage(`${color.hex} copied!`, 'success'))
                                        .catch(() => showMessage('Failed to copy color.', 'error'));
                                });

                                const hexCode = document.createElement('span');
                                hexCode.className = 'text-xs font-mono text-gray-600 mt-1';
                                hexCode.textContent = color.hex;

                                swatchContainer.appendChild(swatch);
                                swatchContainer.appendChild(hexCode);
                                paletteDisplay.appendChild(swatchContainer);
                            });
                        }

                        loadingIndicator.classList.add('hidden');
                        paletteSection.classList.remove('hidden');
                        showMessage('Colors extracted!', 'success');

                    } catch (error) {
                        console.error("Error processing image:", error);
                        showMessage('Error processing image. Please try another.', 'error');
                        loadingIndicator.classList.add('hidden');
                    } finally {
                         extractBtn.disabled = false; // Re-enable button
                    }
                     // --- Image Processing Ends ---
                }
                img.onerror = function() {
                    showMessage('Could not load the image file.', 'error');
                    loadingIndicator.classList.add('hidden');
                    extractBtn.disabled = false;
                }
                img.src = event.target.result;
            };
            reader.onerror = function() {
                 showMessage('Error reading file.', 'error');
                 loadingIndicator.classList.add('hidden');
                 extractBtn.disabled = false;
            }
            reader.readAsDataURL(selectedFile);
        });

    </script>

</body>
</html>
